#include "TSystem.h"
#include "TList.h"
#include "THaRun.h"
#include "THaEvent.h"
#include "THaAnalyzer.h"
#include "THaApparatus.h"


void replay(int run_number=0, int nevents=-1){

  gSystem->Load("libMollerPol");

  MollerPolApparatus *mol = new MollerPolApparatus("M", "Moller polarimeter apparatus");

  // Set up the analyzer - we use the standard one,
  // but this could be an experiment-specific one as well.
  // The Analyzer controls the reading of the data, executes
  // tests/cuts, loops over Apparatus's and PhysicsModules,
  // and executes the output routines.
  THaAnalyzer* analyzer = new THaAnalyzer;
  
  gHaApps->Add(mol);

  // Add event handler for scaler events
  MollerPolScalerEvtHandler* scaler = new MollerPolScalerEvtHandler("M", "scaler event type 1");
  scaler->AddEvtType(1);
  gHaEvtHandlers->Add(scaler);
  scaler->SetDebugFile("DebugScaler.txt");
  
  // A simple event class to be output to the resulting tree.
  // Creating your own descendant of THaEvent is one way of
  // defining and controlling the output.
  THaEvent* event = new THaEvent;
  
  // Define the run(s) that we want to analyze.
  // We just set up one, but this could be many.
//  THaRun* run = new THaRun( "prod12_4100V_TrigRate25_4.dat" );
  THaRun* run = new THaRun( Form("raw/fadcV2_%d.evio.0",run_number) );
  run->SetLastEvent(nevents);

  run->SetDataRequired(0);
  run->SetDate(TDatime());

  analyzer->SetVerbosity(4);
  analyzer->SetOdefFile("replay.odef" );
  
  // Define the analysis parameters
  analyzer->SetEvent( event );
  analyzer->SetOutFile( Form("Rootfiles/fadcV2_moller_analyzer_%d.root", run_number) );
  // File to record cuts accounting information
  analyzer->SetSummaryFile( Form("summary_%d.log", run_number) ); // optional
  
  //analyzer->SetCompressionLevel(0); // turn off compression
  analyzer->Process(run);     // start the actual analysis
}
